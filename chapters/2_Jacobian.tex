\section{Differential Kinematics}

\subsection{Geometric Jacobian}
\vspace*{5pt}
\begin{align*}
	\text{i-th column of } \bm{J} \text{:} \qquad
	\begin{bmatrix}
		\bm{J}_{p,i} \\
		\bm{J}_{o,i}
	\end{bmatrix}
	=
	\begin{cases}
		\begin{bmatrix}
			\bm{z}_{i-1} \\
			\bm{0}
		\end{bmatrix}
		& \textit{for a \textbf{prismatic} joint}
		\vspace*{5pt}
		\\
		\begin{bmatrix}
			\bm{z}_{i-1} \times (\bm{p} - \bm{p}_{i-1}) \\
			\bm{z}_{i-1} 
		\end{bmatrix}
		& \textit{for a \textbf{revolute} joint}
	\end{cases}
\end{align*}

\vspace*{5pt}
%\begin{itemize}
%	\item $\bm{z}_{i-1} = 3^{rd} \text{ column of } {}^0\bm{T}_{i-1} = {}^0\bm{T}_{1} \cdots {}^{i-2}\bm{T}_{i-1}$.
%	\item $\bm{p} = \text{first 3 elements of the last column of } {}^0\bm{T}_n = {}^0\bm{T}_{1} \cdots {}^{n-1}\bm{T}_{}$
%	\item $\bm{p}_{i-1} = \text{first 3 elements of the last column of } {}^0\bm{T}_{i-1} = {}^0\bm{T}_{1} \cdots {}^{i-2}\bm{T}_{i-1}$
%\end{itemize}

\vspace*{8pt}
$$
\begin{bmatrix}0 \\ 0 \\ 1\end{bmatrix}
\times
\begin{bmatrix}x \\ y \\ z\end{bmatrix}
=
\begin{bmatrix}-y \\ x \\ 0\end{bmatrix}
$$


\vspace*{8pt}
\textit{E.g. planar RRR}
$$
J(q)
=
\begin{bmatrix}
	z_0 \times (p - p_0) & z_1 \times (p - p_1) & z_2 \times (p - p_2) \\
	z_0 & z_1 & z_2
\end{bmatrix}
\qquad
\textit{here } \ c_{12} = c(\theta_1+\theta_2)
$$

\newcolumn
\vspace*{-18pt}
\begin{equation*}  
	{}^0T_0
	=
	\begin{bmatrix}
		1 & 0 & \cellcolor{cyan}0 & \cellcolor{yellow}0 \\
		0 & 1 & \cellcolor{cyan}0 & \cellcolor{yellow}0 \\
		0 & 0 & \cellcolor{cyan}1 & \cellcolor{yellow}0 \\
		0 & 0 & 0 & 1 \\
	\end{bmatrix}
	\implies
	\colorbox{cyan}{$z_0$}
	=
	\begin{bmatrix}
		0 \\ 0 \\ 1
	\end{bmatrix}
	\ , \
	\colorbox{yellow}{$p_0$}
	=
	\begin{bmatrix}
		0 \\ 0 \\ 0
	\end{bmatrix}
%	\parbox[position]{4em}{\textbf{N.B.} this is always like this !}
\end{equation*}

\begin{equation*}
	{}^0T_1
	=
	\begin{bmatrix}
		c_1 & -s_1 & \cellcolor{cyan}0 & \cellcolor{yellow}l_1 c_1 \\
		s_1 & c_1 & \cellcolor{cyan}0 & \cellcolor{yellow}l_1 s_1 \\
		0 & 0 & \cellcolor{cyan}1 & \cellcolor{yellow}0 \\
		0 & 0 & 0 & 1 \\
	\end{bmatrix}
	\implies
	\colorbox{cyan}{$z_1$}
	=
	\begin{bmatrix}
		0 \\ 0 \\ 1
	\end{bmatrix}
	\ , \
	\colorbox{yellow}{$p_1$}
	=
	\begin{bmatrix}
		l_1 c_1 \\ l_1 s_1 \\ 0
	\end{bmatrix}
\end{equation*}

%$$
%	\cdots {}^0T_2 = {}^0T_1 {}^1T_2 = \cdots
%$$

\begin{equation*}
	{}^0T_2
	=
	{}^0T_1 {}^1T_2
	=
	\begin{bmatrix}
		c_{12} & -s_{12} & \cellcolor{cyan}0 & \cellcolor{yellow}l_1 c_1 + l_2c_{12}\\
		s_{12} & c_{12} & \cellcolor{cyan}0 & \cellcolor{yellow}l_1 s_1 + l_2s_{12}\\
		0 & 0 & \cellcolor{cyan}1 & \cellcolor{yellow}0 \\
		0 & 0 & 0 & 1 \\
	\end{bmatrix}
	\implies
	\colorbox{cyan}{$z_2$}
	=
	\begin{bmatrix}
		0 \\ 0 \\ 1
	\end{bmatrix}
	\ , \
	\colorbox{yellow}{$p_2$}
	=
	\begin{bmatrix}
		l_1 c_1 + l_2c_{12} \\ l_1 s_1 + l_2s_{12} \\ 0
	\end{bmatrix}
\end{equation*}

\begin{equation*}
	{}^0T_3
	=
	\begin{bmatrix}
		c_{123} & -s_{123} & 0 & \cellcolor{yellow}l_1 c_1 + l_2c_{12} + l_3c_{123}\\
		s_{123} & c_{123} & 0 & \cellcolor{yellow}l_1 s_1 + l_2s_{12} + l_3s_{123}\\
		0 & 0 & 1 & \cellcolor{yellow}0 \\
		0 & 0 & 0 & 1 \\
	\end{bmatrix}
	\implies
	\colorbox{yellow}{$p$}
	=
	\begin{bmatrix}
		l_1 c_1 + l_2c_{12} + l_3c_{123} \\ l_1 s_1 + l_2s_{12} + l_3s_{123} \\ 0
	\end{bmatrix}
\end{equation*}





\subsection{Analytical Jacobian}

\begin{gather*}
\dot{\bm{x}}
=
\begin{bmatrix} \dot{\bm{p}} \\ \dot{\bm{\phi}}\end{bmatrix}
=
\frac{d\bm{x}}{dt}
=
\underbrace{\frac{\partial\bm{x}}{\partial \bm{q}}}_{\bm{J}_A(\bm{q})}
\underbrace{\frac{d\bm{q}}{d t}}_{\dot{\bm{q}}}
=
\bm{J}_A(\bm{q})\dot{\bm{q}}
\ , \
\bm{J}(\bm{q})
=
\begin{bmatrix}
	\bm{I} & \bm{0} \\
	\bm{0} & \bm{T}(\bm{\phi})
\end{bmatrix}
\bm{J}_A(\bm{q})
\ , \
%\parbox[position]{6em}{$T(\phi)$ depends on the attitude represent.}
T(\phi)
\overset{zyz}{=}
\begin{bmatrix}
	0 & -s_\phi & c_\phi s_\theta \\
	0 & c_\theta & s_\phi s_\theta \\
	1 & 0 & c_\theta
\end{bmatrix}
\end{gather*}

\begin{textblock}{5}(6.7,0)
	$\omega = T(\phi) \dot{\phi}$
\end{textblock}


\vspace*{-5pt}
\subsection{Inverse differential kinematics}
\begin{equation*}
\begin{cases}
\text{minimize} & \quad g(\dot{\bm{q}}) = \frac{1}{2} \dot{\bm{q}}^T \bm{W} \dot{\bm{q}} \\
\text{subject to} & \quad \bm{v} = \bm{J}(\bm{q})\bm{\dot{q}}
\end{cases}
\quad 
\overset{\bm{W} = \bm{I}}{\iff}
%\xLeftrightarrow{\bm{W} = \bm{I}}
\quad
\dot{\bm{q}} = \bm{J}^{\dagger}(\bm{q})\bm{v}
\qquad
\bm{J}^{\dagger} \triangleq \bm{J}^T(\bm{J}\bm{J}^T)^{-1}
\end{equation*}

\vspace{10pt}

\begin{equation*}
\begin{cases}
	\text{minimize} & \quad 
	g'(\dot{\bm{q}}) = \frac{1}{2} ( \dot{\bm{q}} - \dot{\bm{q}}_d )^T ( \dot{\bm{q}} - \dot{\bm{q}}_d ) \\
	\text{subject to} & \quad \bm{v} = \bm{J}(\bm{q})\bm{\dot{q}}
\end{cases}
\quad 
\iff
\quad
\dot{\bm{q}} = \bm{J}^{\dagger}(\bm{q})\bm{v}
+
\underbrace{(\bm{I} - \bm{J}^\dagger\bm{J})}_{\text{\emoji{film-projector} in }\mathcal{N}}
\dot{\bm{q}}_d
\end{equation*}

\vspace*{5pt}
\textbf{Damped least-square: }
$$
J = \bm{U\Sigma V}^T , \ \Sigma_{ii} = \sqrt{eig(JJ^T)_i}
\implies
J^\dagger = V\Sigma^\dagger U^T
\quad \overset{\sigma_i \rightarrow 1/(\sigma_i + k^2)}{\implies} \quad
\bm{J}^* = \bm{J}^T(\bm{J}\bm{J}^T + k^2\bm{I})^{-1}
$$

\vspace*{10pt}
\textbf{Secondary objectives}:
\vspace*{5pt}
$$
\dot{\bm{H}}
=
\frac{d\bm{H}}{dt}
=
\frac{\partial\bm{H}}{\partial \bm{q}} \frac{d\bm{q}}{dt}
=
\frac{\partial\bm{H}}{\partial \bm{q}} \bm{\dot{q}}
\quad
\text{with}
\quad
\dot{\bm{q}}_d = -K(\frac{\partial\bm{H}}{\partial \bm{q}})^T \ , \ K > 0
$$


$$
\dot{\bm{H}}
=
\underbrace{
	\frac{\partial\bm{H}}{\partial \bm{q}} \bm{J}^{\dagger}(\bm{q})\bm{v}
}_{\text{non si sa}}
+
\underbrace{
	-K\frac{\partial\bm{H}}{\partial \bm{q}}(\bm{I} - \bm{J}^\dagger\bm{J})(\frac{\partial\bm{H}}{\partial \bm{q}})^T
}_{<0}
$$

\begin{itemize}
	\item \textbf{Max dist. obstacles}: 
	$
	H = \min_{p,o} \| p(q) - o \| \qquad \rightsquigarrow H\uparrow
	$
	
	\item \textbf{Max dist. joint limit}: 
	$
	H(q)=-{\frac{1}{2n}}\sum_{i=1}^{n}\left({\frac{q_{i}-{\bar{q}}_{i}}{q_{i M}-q_{i m}}}\right)^{2} \qquad \rightsquigarrow H\downarrow
	$

	\item \textbf{Max dist. from singularities}: 
	$
	H(q)=\sqrt{\operatorname*{det}(J(q)J^{T}(q))} \qquad \rightsquigarrow H\uparrow
	$
\end{itemize}




